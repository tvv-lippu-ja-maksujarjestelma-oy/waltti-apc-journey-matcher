# waltti-apc-journey-matcher

Match APC messages from the vehicles with GTFS Realtime messages to augment the APC messages with vehicle journey metadata.

To do the matching, one needs a few mappings between IDs.
The counting system map (counting system ID → vehicle and vendor) can be provided either:

- **Statically** via the `COUNTING_SYSTEM_MAP` environment variable, or  
- **Dynamically** by consuming vehicle catalogue topics from the vehicle registry (see configuration). When the vehicle registry consumer is configured, the counting system map and the set of included vehicles are updated from incoming vehicle-catalogue messages; a static `COUNTING_SYSTEM_MAP` is then optional and can be used to seed or override.

This repository has been created as part of the [Waltti APC](https://github.com/tvv-lippu-ja-maksujarjestelma-oy/waltti-apc) project.

## Development

1. Create a suitable `.env` file for configuration.
   Check below for the configuration reference.
1. Create any necessary secrets that the `.env` file points to.
1. Install dependencies:

   ```sh
   npm install
   ```

1. Run linters and tests and build:

   ```sh
   npm run check-and-build
   ```

1. Load the environment variables:

   ```sh
   set -a
   source .env
   set +a
   ```

1. Run the application:

   ```sh
   npm start
   ```

## Docker

You can use the Docker image `tvvlmj/waltti-apc-journey-matcher:edge`.
Check out [the available tags](https://hub.docker.com/r/tvvlmj/waltti-apc-journey-matcher/tags).

## Configuration

| Environment variable                    | Required? | Default value | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| --------------------------------------- | --------- | ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `APC_WAIT_IN_SECONDS`                   | ❌ No     | `6`           | A float describing how long to wait accumulating more APC data after a GTFS Realtime event has triggered the sending process for this vehicle and stop but before sending the summed values onwards for this vehicle and stop.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `COUNTING_SYSTEM_MAP`                   | ❌ No     |               | Optional static map from counting system IDs to vehicles and vendor names. When the vehicle registry consumer is configured, the map is built dynamically from vehicle catalogue messages; this variable can then be omitted or used to seed/override. Format: stringified JSON array like `Map.prototype.entries()`, e.g. `[[\"c5e96843-e820-4837-8eef-6176be4b4c4e\",[\"fi:jyvaskyla:6714_503\",\"Acme\"]],[\"6dd41f2e-841f-44a0-b5f8-a108847dc4a2\",[\"fi:jyvaskyla:6714_529\",\"Corpcorp\"]]]`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `FEED_MAP`                              | ✅ Yes    |               | A map from Pulsar topics to feed publisher IDs, Waltti OpenData Authority IDs and timezone names. The map is given in the form of a stringified JSON array of strings in the shape `[[pulsarTopic1, [feedPublisher1, walttiOpenDataAuthority1, timezone1]], [pulsarTopic2, [feedPublisher2, walttiOpenDataAuthority2, timezone2]], ...]` like the output of `Map.prototype.entries()`. The feed publisher ID is a unique ID for the authority or the GTFS feed publisher whose APC data will be handled. The format is `<country-code>:<name>` where `<country-code>` follows a _lowercase_ version of [ISO 3166-1 alpha-2](https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2) and `<name>` is unique within the country. An example could be `fi:jyvaskyla`. The corresponding Waltti OpenData Authority IDs are listed here: https://opendata.waltti.fi/docs#gtfs-static-packages . The timezone name refers to the timezone used by the authority or the GTFS feed publisher for local time. It is given in the format of an [IANA timezone (tz database)](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones), e.g. `Europe/Helsinki`. An example of the whole list could be `[[\"persistent://apc-dev/source/gtfs-realtime-vp-fi-kuopio\",[\"fi:kuopio\",\"221\",\"Europe/Helsinki\"]],[\"persistent://apc-dev/source/gtfs-realtime-vp-fi-jyvaskyla\",[\"fi:jyvaskyla\",\"209\",\"Europe/Helsinki\"]]]`. |
| `HEALTH_CHECK_PORT`                     | ❌ No     | `8080`        | Which port to use to respond to health checks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `PINO_LOG_LEVEL`                        | ❌ No     | `info`        | The level of logging to use. One of "fatal", "error", "warn", "info", "debug", "trace" or "silent".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `PULSAR_APC_CONSUMER_TOPICS_PATTERN`    | ✅ Yes    |               | The topic pattern to consume APC vehicle messages from.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `PULSAR_APC_SUBSCRIPTION`               | ✅ Yes    |               | The name of the subscription for reading messages from `PULSAR_APC_CONSUMER_TOPICS_PATTERN`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `PULSAR_BLOCK_IF_QUEUE_FULL`            | ❌ No     | `true`        | Whether the send operations of the producer should block when the outgoing message queue is full. If false, send operations will immediately fail when the queue is full.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `PULSAR_COMPRESSION_TYPE`               | ❌ No     | `ZSTD`        | The compression type to use in the topic where messages are sent. Must be one of `Zlib`, `LZ4`, `ZSTD` or `SNAPPY`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `PULSAR_GTFSRT_CONSUMER_TOPICS_PATTERN` | ✅ Yes    |               | The topic pattern to consume GTFS Realtime messages from.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `PULSAR_GTFSRT_SUBSCRIPTION`            | ✅ Yes    |               | The name of the subscription for reading messages from `PULSAR_GTFSRT_CONSUMER_TOPICS_PATTERN`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `PULSAR_VEHICLE_REGISTRY_CONSUMER_TOPICS_PATTERN` | ❌ No     |               | Optional. Topic pattern for vehicle catalogue (vehicle registry) messages. When set together with `PULSAR_VEHICLE_REGISTRY_SUBSCRIPTION`, the counting system map and included vehicles are updated from these messages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `PULSAR_VEHICLE_REGISTRY_SUBSCRIPTION`  | ❌ No     |               | Subscription name for the vehicle registry consumer. Required if `PULSAR_VEHICLE_REGISTRY_CONSUMER_TOPICS_PATTERN` is set.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| `PULSAR_OAUTH2_AUDIENCE`                | ❌ No     |               | Optional OAuth2 audience. If any of the OAuth2 variables are set, all three (`PULSAR_OAUTH2_ISSUER_URL`, `PULSAR_OAUTH2_KEY_PATH`, `PULSAR_OAUTH2_AUDIENCE`) must be set. If none are set, Pulsar authentication is disabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `PULSAR_OAUTH2_ISSUER_URL`              | ❌ No     |               | Optional OAuth2 issuer URL. If any of the OAuth2 variables are set, all three (`PULSAR_OAUTH2_ISSUER_URL`, `PULSAR_OAUTH2_KEY_PATH`, `PULSAR_OAUTH2_AUDIENCE`) must be set. If none are set, Pulsar authentication is disabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `PULSAR_OAUTH2_KEY_PATH`                | ❌ No     |               | Optional path to the OAuth2 private key JSON file. If any of the OAuth2 variables are set, all three (`PULSAR_OAUTH2_ISSUER_URL`, `PULSAR_OAUTH2_KEY_PATH`, `PULSAR_OAUTH2_AUDIENCE`) must be set. If none are set, Pulsar authentication is disabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `PULSAR_PRODUCER_TOPIC`                 | ✅ Yes    |               | The topic to send messages to.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `PULSAR_SERVICE_URL`                    | ✅ Yes    |               | The service URL.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `PULSAR_TLS_VALIDATE_HOSTNAME`          | ❌ No     | `true`        | Whether to validate the hostname on its TLS certificate. This option exists because some Apache Pulsar hosting providers cannot handle Apache Pulsar clients setting this to `true`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

Note on Pulsar OAuth2:

- If any of `PULSAR_OAUTH2_ISSUER_URL`, `PULSAR_OAUTH2_KEY_PATH`, or `PULSAR_OAUTH2_AUDIENCE` is set, then all three must be set.
- If none are set, the Pulsar client connects without OAuth2 authentication.
